ARG BASE=nvidia/cuda:12.6.1-devel-ubuntu24.04
FROM ${BASE} AS working

# ───────────────────────────────────────────────────────────────────
# To fix tzdata asking for a timezone during installation
# can set up later using sudo dpkg-reconfigure tzdata I think.

ARG DEBIAN_FRONTEND=noninteractive

# ───────────────────────────────────────────────────────────────────
# Install apt packages, first pass

# Install basic Ubuntu packages and TensorFlow dependencies. 

RUN apt-get -y update && apt-get install -y apt-utils && apt-get \
  -y install -o Debug::pkgProblemResolver=yes \
  g++ make autoconf automake libtool git curl cmake \
  python3 libz-dev libsz2 imagemagick python3-pip \
  cudnn9-cuda-12-6 && apt-get clean 

# ───────────────────────────────────────────────────────────────────
# Install tensorflow

# PyTorch offers separate pip wheels for different CUDA versions.
RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128

RUN pip3 install --break-system-packages torch==2.6.0

# ───────────────────────────────────────────────────────────────────

COPY torch_check.sh


RUN nvidia-smi
RUN nvcc --version
RUN python3 -c "import torch"
RUN python3 -c "import tensorflow as tf; print(torch.cuda.is_available())"
        
FROM working





